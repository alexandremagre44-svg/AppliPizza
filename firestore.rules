rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // HELPER FUNCTIONS
    // ============================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin (via custom claim OR hardcoded UID for backward compatibility)
    function isAdmin() {
      return request.auth != null && 
             (request.auth.token.admin == true || 
              request.auth.uid == "dbmnp2DdyJaURWJO4YEE5fgv3002");
    }
    
    // Check if authenticated user owns the document (userId field matches auth uid)
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================================================
    // RÈGLES POUR APP_CONFIGS (Studio B3, Migration, Init Auto)
    // ============================================================================
    // Structure: app_configs/{appId}/configs/{config|config_draft}
    // 
    // Permissions:
    // - Admin: read/write sur tout (draft + published)
    // - Public: read-only sur published uniquement
    // - Aucune écriture publique autorisée
    // ============================================================================
    
    match /app_configs/{appId}/configs/{configDoc} {
      // Admin: accès complet (Studio B3, Migration, Init)
      allow read, write: if isAdmin();
      
      // Public: lecture seule du config publié uniquement
      allow read: if configDoc == "config";
      
      // Aucune écriture publique autorisée (même authentifié)
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR PRODUCTS (Catalogue)
    // ============================================================================
    // Structure: products/{productId}
    //
    // Permissions:
    // - Admin: read/write (gestion des produits)
    // - Public: read-only (affichage menu app)
    // ============================================================================
    
    match /products/{productId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Public: lecture seule pour affichage dans l'app
      allow read: if true;
      
      // Aucune écriture publique
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR CATEGORIES
    // ============================================================================
    // Structure: categories/{categoryId}
    //
    // Permissions:
    // - Admin: read/write (gestion des catégories)
    // - Public: read-only (navigation app)
    // ============================================================================
    
    match /categories/{categoryId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Public: lecture seule
      allow read: if true;
      
      // Aucune écriture publique
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR INGREDIENTS
    // ============================================================================
    // Structure: ingredients/{ingredientId}
    //
    // Permissions:
    // - Admin: read/write (gestion des ingrédients)
    // - Public: read-only (personnalisation pizzas)
    // ============================================================================
    
    match /ingredients/{ingredientId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Public: lecture seule
      allow read: if true;
      
      // Aucune écriture publique
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR UPLOADS (Media Manager)
    // ============================================================================
    // Structure: uploads/{userId}/{fileId}
    //
    // Permissions:
    // - Admin uniquement: read/write (téléchargement et gestion des médias)
    // - Aucun accès public
    // ============================================================================
    
    match /uploads/{userId}/{fileId} {
      // Admin: accès complet pour Media Manager
      allow read, write: if isAdmin();
      
      // Aucun accès public
      allow read, write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR ORDERS (Commandes)
    // ============================================================================
    // Structure: orders/{orderId}
    //
    // Permissions:
    // - Admin: read/write (gestion commandes)
    // - Client authentifié: read ses propres commandes uniquement
    // - Client authentifié: create pour passer commande
    // ============================================================================
    
    match /orders/{orderId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Client: lecture de ses propres commandes
      allow read: if request.auth != null 
                  && request.auth.uid == resource.data.userId;
      
      // Client: création de commande uniquement
      allow create: if request.auth != null
                    && request.auth.uid == request.resource.data.userId;
      
      // Aucune modification/suppression par client
      allow update, delete: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR USER_PROFILES (Profils utilisateurs)
    // ============================================================================
    // Structure: user_profiles/{userId}
    //
    // Permissions:
    // - Admin: read/write complet
    // - User authentifié: read/write son propre profil uniquement
    // ============================================================================
    
    match /user_profiles/{userId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: accès à son propre profil uniquement
      allow read, write: if request.auth != null 
                         && request.auth.uid == userId;
      
      // Aucun accès aux profils des autres users
      allow read, write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR CARTS (Paniers)
    // ============================================================================
    // Structure: carts/{userId}
    //
    // Permissions:
    // - Admin: read/write complet
    // - User authentifié: read/write son propre panier uniquement
    // ============================================================================
    
    match /carts/{userId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: accès à son propre panier uniquement
      allow read, write: if request.auth != null 
                         && request.auth.uid == userId;
      
      // Aucun accès aux paniers des autres users
      allow read, write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR LOYALTY (Programme de fidélité)
    // ============================================================================
    // Structure: loyalty/{userId}
    //
    // Permissions:
    // - Admin: read/write complet (gestion du programme)
    // - User authentifié: read son propre compte fidélité uniquement
    // - Aucune écriture user (points gérés par admin/backend)
    // ============================================================================
    
    match /loyalty/{userId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: lecture de son propre compte uniquement
      allow read: if request.auth != null 
                  && request.auth.uid == userId;
      
      // Aucune écriture par user (éviter la fraude)
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR PROMOTIONS
    // ============================================================================
    // Structure: promotions/{promoId}
    //
    // Permissions:
    // - Admin: read/write (gestion des promos)
    // - Public: read-only (affichage des offres)
    // ============================================================================
    
    match /promotions/{promoId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Public: lecture seule
      allow read: if true;
      
      // Aucune écriture publique
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR CAMPAIGNS (Campagnes marketing)
    // ============================================================================
    // Structure: campaigns/{campaignId}
    //
    // Permissions:
    // - Admin uniquement (gestion marketing)
    // - Aucun accès public
    // ============================================================================
    
    match /campaigns/{campaignId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Aucun accès public
      allow read, write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR SUBSCRIBERS (Newsletters)
    // ============================================================================
    // Structure: subscribers/{subscriberId}
    //
    // Permissions:
    // - Admin: read/write complet (gestion mailing)
    // - Public: create uniquement (inscription newsletter)
    // ============================================================================
    
    match /subscribers/{subscriberId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Public: création uniquement (inscription)
      allow create: if true;
      
      // Aucune lecture/modification publique
      allow read, update, delete: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR EMAIL_TEMPLATES
    // ============================================================================
    // Structure: email_templates/{templateId}
    //
    // Permissions:
    // - Admin uniquement (configuration emails)
    // ============================================================================
    
    match /email_templates/{templateId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Aucun accès public
      allow read, write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR _b3_test (Tests d'initialisation B3)
    // ============================================================================
    // Structure: _b3_test/{testDoc}
    //
    // Permissions:
    // - Admin uniquement (tests techniques)
    // - Utilisé par autoInitializeB3IfNeeded() pour tester les permissions
    // ============================================================================
    
    match /_b3_test/{testDoc} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Aucun accès public
      allow read, write: if false;
    }
    
    // ============================================================================
    // PHASE 2 SECURITY HARDENING - 11 CRITICAL COLLECTIONS
    // ============================================================================
    
    // ============================================================================
    // RÈGLES POUR REWARD TICKETS (Programme de fidélité)
    // ============================================================================
    // Structure: rewardTickets/{ticketId}
    //
    // Permissions:
    // - Admin: full read/write (création et gestion des tickets)
    // - User: read own tickets only (via userId field)
    // - No user write (prevent fraud)
    // ============================================================================
    
    match /rewardTickets/{ticketId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: lecture de ses propres tickets uniquement
      allow read: if isAuthenticated() 
                  && request.auth.uid == resource.data.userId;
      
      // Aucune écriture par user (fraude)
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR ROULETTE SEGMENTS (Configuration du jeu)
    // ============================================================================
    // Structure: roulette_segments/{segmentId}
    //
    // Permissions:
    // - Admin: write only (configuration des gains)
    // - Public: read (affichage roulette)
    // - No user write (prevent manipulation)
    // ============================================================================
    
    match /roulette_segments/{segmentId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Public: lecture seule (affichage app)
      allow read: if true;
      
      // Aucune écriture publique
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR ROULETTE HISTORY (Historique des parties)
    // ============================================================================
    // Structure: roulette_history/{historyId}
    //
    // Permissions:
    // - Admin: full access
    // - User: read/write own history only
    // ============================================================================
    
    match /roulette_history/{historyId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: accès à son propre historique uniquement
      allow read, write: if isAuthenticated() 
                         && request.auth.uid == resource.data.userId;
      
      // User: création de son propre historique
      allow create: if isAuthenticated() 
                    && request.auth.uid == request.resource.data.userId;
    }
    
    // ============================================================================
    // RÈGLES POUR USER ROULETTE SPINS (Compteur de spins)
    // ============================================================================
    // Structure: user_roulette_spins/{userId}
    //
    // Permissions:
    // - Admin: full access (system management)
    // - User: read own only
    // - No user write (prevent counter reset)
    // ============================================================================
    
    match /user_roulette_spins/{userId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: lecture de son propre compteur uniquement
      allow read: if isOwner(userId);
      
      // Aucune écriture user (éviter reset)
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR ROULETTE RATE LIMIT (Anti-abus roulette)
    // ============================================================================
    // Structure: roulette_rate_limit/{userId}
    //
    // Permissions:
    // - Admin: full access
    // - User: read own limit status
    // - No user write (system managed)
    // ============================================================================
    
    match /roulette_rate_limit/{userId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: lecture de son propre rate limit
      allow read: if isOwner(userId);
      
      // Aucune écriture user (système géré)
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR ORDER RATE LIMIT (Anti-spam commandes)
    // ============================================================================
    // Structure: order_rate_limit/{userId}
    //
    // Permissions:
    // - Admin: full access
    // - User: write own rate limit doc (system tracks)
    // ============================================================================
    
    match /order_rate_limit/{userId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: accès à son propre rate limit
      allow read, write: if isOwner(userId);
    }
    
    // ============================================================================
    // RÈGLES POUR USER POPUP VIEWS (Tracking UI)
    // ============================================================================
    // Structure: user_popup_views/{userId}
    //
    // Permissions:
    // - Admin: full access
    // - User: read/write own popup views
    // ============================================================================
    
    match /user_popup_views/{userId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: accès à ses propres vues de popup
      allow read, write: if isOwner(userId);
    }
    
    // ============================================================================
    // RÈGLES POUR APPS (Configuration multi-app superadmin)
    // ============================================================================
    // Structure: apps/{appId}
    //
    // Permissions:
    // - Admin only (superadmin management)
    // - No public access
    // ============================================================================
    
    match /apps/{appId} {
      // Admin: accès complet (SuperAdmin uniquement)
      allow read, write: if isAdmin();
      
      // Aucun accès public
      allow read, write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR RESTAURANTS (White-label restaurant data)
    // ============================================================================
    // Structure: restaurants/{restaurantId}
    //
    // Permissions:
    // - Admin: full write access (superadmin + wizard)
    // - Public: read basic info (client app)
    // ============================================================================
    
    match /restaurants/{restaurantId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Public: lecture seule (informations restaurant)
      allow read: if true;
      
      // Aucune écriture publique
      allow write: if false;
    }
    
    // Sous-collections de restaurants (plan, settings, etc.)
    match /restaurants/{restaurantId}/{subcollection}/{docId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // Public: lecture seule
      allow read: if true;
      
      // Aucune écriture publique
      allow write: if false;
    }
    
    // ============================================================================
    // RÈGLES POUR USERS (User management superadmin)
    // ============================================================================
    // Structure: users/{userId}
    //
    // Permissions:
    // - Admin: full access (user management)
    // - User: read/write own profile
    // ============================================================================
    
    match /users/{userId} {
      // Admin: accès complet
      allow read, write: if isAdmin();
      
      // User: accès à son propre profil uniquement
      allow read, write: if isOwner(userId);
    }
    
    // ============================================================================
    // RÈGLES POUR BUILDER B3 (Page Builder System)
    // ============================================================================
    // Structure: builder/{path=**}
    //
    // Permissions:
    // - Admin only (Builder B3 access)
    // - No public access
    // ============================================================================
    
    match /builder/{path=**} {
      // Admin: accès complet (Builder B3)
      allow read, write: if isAdmin();
      
      // Aucun accès public
      allow read, write: if false;
    }
    
    // ============================================================================
    // RÈGLE PAR DÉFAUT - DÉNI TOTAL
    // ============================================================================
    // Toute collection non explicitement listée ci-dessus est interdite
    // Principe de sécurité: deny by default
    // ============================================================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
